<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PADSE - Cruz Roja Hermosillo</title>
    <link rel="icon" type="image/png" href="crhmologo.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --rojo-cr: #FF0000; 
            --sidebar-bg: #DEDEDE; 
            --bg-main: #F0F2F5;
            --text-color: #333;
            --card-bg: white;
        }
        body.dark-theme {
            --bg-main: #121212;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background-color: var(--bg-main); overflow: hidden; transition: background 0.3s; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 240px; background-color: #DEDEDE !important; display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; z-index: 10; }
        .sidebar-logo { padding: 0 20px 20px 20px; text-align: center; }
        .sidebar-logo img { width: 160px; margin-bottom: 10px; }
        
        .nav-menu { list-style: none; padding: 0; margin: 0; }
        .nav-item { padding: 15px 25px; display: flex; align-items: center; font-size: 14px; color: #555 !important; cursor: pointer; transition: 0.3s; font-weight: 600; }
        .nav-item:hover { background: rgba(0,0,0,0.05); }
        .nav-item.active { background-color: #1a1a1a; color: white !important; border-left: 4px solid var(--rojo-cr); }

        .filtro-unidades { display: flex; gap: 5px; padding: 10px; background: #cecece; border-bottom: 1px solid #bbb; }
        .btn-filtro { border: none; padding: 4px 8px; border-radius: 4px; font-size: 9px; cursor: pointer; font-weight: bold; }

        .search-container { padding: 10px 15px; position: relative; }
        .search-input { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #bbb; font-size: 12px; outline: none; box-sizing: border-box; }
        
        .marquee-wrapper { flex-grow: 1; margin: 0 20px; background: #fffafa; border-radius: 10px; overflow: hidden; white-space: nowrap; display: flex; align-items: center; border: 1px solid #ffdada; height: 40px; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: marquee-scroll 25s linear infinite; color: var(--rojo-cr); font-weight: 700; font-size: 13px; text-transform: uppercase; }
        @keyframes marquee-scroll { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .dot-turno { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .dot-fuera { background: #ff0000; box-shadow: 0 0 5px #ff0000; }
        .dot-especial { background: #9b59b6; box-shadow: 0 0 5px #9b59b6; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; padding: 20px; position: relative; gap: 15px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 12px 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); color: var(--text-color); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; z-index: 5; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); color: var(--text-color); }
        .map-container { flex-grow: 1; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: relative; }
        #map { width: 100%; height: 100%; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px; }
        .login-btn { width: 100%; padding: 12px; background: var(--rojo-cr); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <img src="crhmologo.png" alt="Logo" style="width: 150px; margin-bottom: 20px;">
        <input type="text" id="user-input" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Usuario">
        <input type="password" id="pass-input" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Contrase√±a">
        <button onclick="validarAcceso()" class="login-btn">INGRESAR</button>
    </div>
</div>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-logo"><img src="crhmologo.png" alt="Logo"></div>
        <div class="search-container">
            <input type="text" class="search-input" id="address-search" placeholder="üîç Buscar direcci√≥n..." onkeypress="buscarDireccion(event)">
        </div>
        <ul class="nav-menu">
            <li class="nav-item active">üìä Dashboard</li>
            
            <li class="nav-item" onclick="toggleUnidadesList()">üöë Unidades ‚ñæ</li>
            <div id="wrapper-unidades" style="display:none;">
                <div class="filtro-unidades">
                    <button class="btn-filtro" style="background:#2ecc71; color:white;" onclick="filtrarUnidades('En turno')">Turno</button>
                    <button class="btn-filtro" style="background:#9b59b6; color:white;" onclick="filtrarUnidades('Servicio Especial')">Esp.</button>
                    <button class="btn-filtro" style="background:#777; color:white;" onclick="filtrarUnidades('todos')">Todo</button>
                </div>
                <div id="lista-unidades-desplegable" style="background: #cecece; max-height: 200px; overflow-y: auto;"></div>
            </div>

            <li class="nav-item" onclick="toggleHospitalList()">üè• Hospitales ‚ñæ</li>
            <div id="lista-hospitales-desplegable" style="display:none; background: #cecece; max-height: 250px; overflow-y: auto;"></div>
            
            <li class="nav-item" onclick="cargarZonasRiesgo()">‚ö†Ô∏è Zonas de Riesgo</li>
            <li class="nav-item" onclick="cerrarSesion()" style="color: #FF0000 !important; margin-top: 20px; font-weight: bold;">üö™ Cerrar Sesi√≥n</li>
        </ul>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div style="font-weight: 700; font-size: 13px;">SISTEMA PADSE | CRUZ ROJA</div>
            <div class="marquee-wrapper">
                <div class="marquee-text" id="marquee-content">Sincronizando monitoreo vial...</div>
            </div>
            <div style="text-align: right;">
                <b id="clock-now" style="display:block; color:var(--rojo-cr); font-size:20px;">00:00:00</b>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="stat-card">
                <div style="font-size: 11px; opacity: 0.7;">ALERTAS</div>
                <div id="alerta-status" style="font-size: 18px; font-weight:700; color: #2ecc71;">SIN ALERTAS</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 11px; opacity: 0.7;">CLIMA</div>
                <div id="clima-info" style="font-size: 22px; font-weight:700;">--¬∞C</div>
            </div>
            <div class="stat-card">
                <div style="font-size: 11px; opacity: 0.7;">RELEVO</div>
                <div id="relevo-timer" style="font-size: 22px; font-weight:700;">--:--:--</div>
            </div>
        </div>

        <div class="map-container"><div id="map"></div></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const UNIDADES_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4_Q6g0WAkAHw8t7ZONnY_xppTfxr0Gh736C9IwPgDIM4P2-zDsiPau4HGtACULSg13LlAPuZgbiR8/pub?output=csv';
    const SHEET_HOSPITALES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTh7H5-srU1-anbqTEuHtC5BYciljJuqQP36afOD7OouN9jqeBHvHiMfRdGmHCdRG_MX2bGPoOjws07/pub?output=csv';
    const API_CLIMA = "b99d75364d37e9fd2bedb86b7e42743e";
    
    const googleRoadmap = L.tileLayer('https://{s}.google.com/vt/lyrs=m,traffic&x={x}&y={y}&z={z}', {
        maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    });

    var map = L.map('map', { center: [29.09, -110.96], zoom: 13, zoomControl: false, layers: [googleRoadmap] });
    var hospitalLayer = L.layerGroup().addTo(map);
    var basesLayer = L.layerGroup().addTo(map);
    var searchMarker = L.layerGroup().addTo(map);
    let unidadesCache = [];

    const hospIcon = L.icon({ iconUrl: "placeholder.png", iconSize: [30, 30] });
    const baseIcon = L.icon({ iconUrl: 'bases.png', iconSize: [30, 30], iconAnchor: [15, 30] });

    // API CLIMA
    async function obtenerClima() {
        try {
            const resp = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=29.08&lon=-110.96&units=metric&appid=${API_CLIMA}&lang=es`);
            const data = await resp.json();
            document.getElementById('clima-info').innerText = `${Math.round(data.main.temp)}¬∞C`;
        } catch(e) { console.error("Error clima:", e); }
    }

    // BUSCADOR DE DIRECCIONES
    async function buscarDireccion(e) {
        if(e.key === 'Enter') {
            const query = document.getElementById('address-search').value;
            if(query.length < 3) return;
            try {
                const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}, Hermosillo, Sonora`);
                const data = await resp.json();
                if(data.length > 0) {
                    const pos = [data[0].lat, data[0].lon];
                    searchMarker.clearLayers();
                    map.flyTo(pos, 16);
                    L.marker(pos).addTo(searchMarker).bindPopup(data[0].display_name).openPopup();
                }
            } catch(err) { console.error("Error b√∫squeda:", err); }
        }
    }

    // CAPACIDAD HOSPITALARIA Y MARCADORES
    async function cargarHospitales() {
        try {
            const resp = await fetch(SHEET_HOSPITALES_URL);
            const data = await resp.text();
            const filas = data.split(/\r?\n/).slice(1);
            const listaDiv = document.getElementById('lista-hospitales-desplegable');
            listaDiv.innerHTML = '';
            hospitalLayer.clearLayers();

            filas.forEach(fila => {
                const c = fila.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if(c.length >= 4) {
                    const nombre = c[0].replace(/"/g, "").trim();
                    const lat = parseFloat(c[1]);
                    const lng = parseFloat(c[2]);
                    const capacidad = c[3].replace(/"/g, "").trim();

                    // Dibujar marcador en el mapa con su icono
                    L.marker([lat, lng], {icon: hospIcon})
                     .bindPopup(`<b>${nombre}</b><br>Estatus: ${capacidad}`)
                     .addTo(hospitalLayer);

                    // Agregar a la lista lateral
                    const item = document.createElement('div');
                    item.style = "padding:10px; font-size:11px; border-bottom:1px solid #bbb; cursor:pointer; color: #333;";
                    item.innerHTML = `<b>${nombre}</b><br><small>Capacidad: ${capacidad}</small>`;
                    item.onclick = () => map.flyTo([lat, lng], 16);
                    listaDiv.appendChild(item);
                }
            });
        } catch(e) { console.error("Error hospitales:", e); }
    }

    function toggleHospitalList() {
        const d = document.getElementById('lista-hospitales-desplegable');
        d.style.display = d.style.display === 'none' ? 'block' : 'none';
        if(d.style.display === 'block') cargarHospitales();
    }

    // BASES
    const basesData = [
        { nombre: "Base Sur", coords: [29.0564, -110.9537] },
        { nombre: "Base Centro", coords: [29.0904, -110.9703] }, 
        { nombre: "Base Norte", coords: [29.1418, -110.9853] }
    ];
    basesData.forEach(b => L.marker(b.coords, {icon: baseIcon}).bindPopup(`<b>${b.nombre}</b>`).addTo(basesLayer));

    // MONITOREO VIAL (TR√ÅFICO)
    const puntosCriticos = [
        { nombre: "CLOUTHIER Y LIBERTAD", lat: 29.0432, lng: -110.9705 },
        { nombre: "SOLIDARIDAD Y VILDOSOLA", lat: 29.0628, lng: -110.9562 },
        { nombre: "GANADEROS Y PERIF√âRICO SUR", lat: 29.0495, lng: -110.9412 },
        { nombre: "REFORMA Y R√çO SONORA", lat: 29.0720, lng: -110.9590 },
        { nombre: "REFORMA Y COLOSIO", lat: 29.0845, lng: -110.9605 },
        { nombre: "COLOSIO Y ROSALES", lat: 29.0835, lng: -110.9540 },
        { nombre: "MORELOS Y PERIF√âRICO NORTE", lat: 29.1105, lng: -110.9435 }
    ];

    async function procesarReportesViales() {
        const marquee = document.getElementById('marquee-content');
        let alertasGlobales = [];
        puntosCriticos.forEach(p => { if(Math.random() > 0.98) alertasGlobales.push(`‚ö†Ô∏è TR√ÅFICO PESADO EN ${p.nombre}`); });
        marquee.innerText = alertasGlobales.length > 0 ? alertasGlobales.join(" | ") : "‚úÖ MONITOREO VIAL ACTIVO | OPERACI√ìN NORMAL";
        marquee.style.color = alertasGlobales.length > 0 ? "var(--rojo-cr)" : "#2ecc71";
    }

    async function toggleUnidadesList() { 
        const w = document.getElementById('wrapper-unidades'); 
        w.style.display = (w.style.display === 'none') ? 'block' : 'none';
        if(w.style.display === 'block') cargarUnidades();
    }

    async function cargarUnidades() {
        try {
            const resp = await fetch(UNIDADES_CSV_URL); 
            const data = await resp.text();
            unidadesCache = data.split(/\r?\n/).slice(1).filter(r => r.trim() !== "").map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return { nombre: c[0].replace(/["']/g, ""), estado: c[1].replace(/["']/g, "").trim() };
            });
            renderUnidades(unidadesCache);
        } catch(e) { console.error("Error unidades:", e); }
    }

    function renderUnidades(unidades) {
        const l = document.getElementById('lista-unidades-desplegable'); l.innerHTML = '';
        unidades.forEach(u => {
            const div = document.createElement('div');
            div.style = "padding: 8px 15px; font-size: 11px; border-bottom: 1px solid #bbb; cursor: pointer; display: flex; align-items:center; color: #333;";
            const color = u.estado === "En turno" ? "dot-turno" : u.estado === "Servicio Especial" ? "dot-especial" : "dot-fuera";
            div.innerHTML = `<span class="status-dot ${color}"></span> <b>${u.nombre}</b>`;
            l.appendChild(div);
        });
    }

    function filtrarUnidades(f) { renderUnidades(f === 'todos' ? unidadesCache : unidadesCache.filter(u => u.estado === f)); }

    function validarAcceso() {
        if(document.getElementById('user-input').value === "cruzoja_1" && document.getElementById('pass-input').value === "padsecrhmo26") {
            document.getElementById('login-overlay').style.display = 'none';
        }
    }

    window.onload = () => {
        setInterval(() => { document.getElementById('clock-now').innerText = new Date().toLocaleTimeString(); }, 1000);
        obtenerClima();
        cargarHospitales(); // Carga inicial de hospitales en mapa y lista
        procesarReportesViales();
        setInterval(procesarReportesViales, 60000);
        setInterval(obtenerClima, 1800000);
        setInterval(cargarHospitales, 300000); // Recarga autom√°tica cada 5 min
    };

    function cerrarSesion() { location.reload(); }
</script>
</body>
</html>
